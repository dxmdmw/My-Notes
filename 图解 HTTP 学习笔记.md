# 第 1 章  了解 Web 及网络基础
## 1.1 Web 基础

> 根据 Web 浏览器地址栏中指定的 URL，Web 浏览器从 Web 服务器端获取文件资源（resource）等信息，从而显示出 Web 页面。
> Web 使用一种名为 HPPT（HyperText Transfer Protocol，超文本传输协议）的协议作为规范，完成从客户端到服务器端等一系列运作流程。
> 3 项 WWW 构建技术，分别是：把 SGML（Standard Generalized Markup Language，标准通用标记语言）作为页面的文本标记语言的 HTML（HyperText Markup Language，超文本标记语言）；作为文档传递协议的 HTTP；指定文档所在地址的 URL（Uniform Resource Locator，统一资源定位符）。

## 1.2 TCP/IP 

> TCP/IP 是互联网相关的各类协议族的总称。协议中存在各式各样的内容。从电缆的规格到 IP 地址的选定方法、寻找异地用户的方法、双方建立通信的顺序，以及 Web 页面显示需要处理的步骤，等等。
> TCP/IP 协议族按层次分为四层：应用层、传输层、网络层和数据链路层。
> 1. 应用层决定了向用户提供应用服务时通信的活动。比如 FTP（File Transfer Protocol，文件传输协议）和 DNS（Domain Name System，域名系统）服务就是其中两类。HPPT 协议也处于该层。
> 2. 传输层对上层应用层，提供处于网络连接中的两台计算机之间的数据传输。其中两个性质不同的协议：TCP（Transmission Control Protocol，传输控制协议）和 UDP（User Data Protocol，用户数据包协议）。
> 3. 网络层（又名网络互连层）用来处理在网络上流动的数据包（网络传输的最小数据单位）。该层规定了通过怎样的路径到达对方计算机，并把数据包传送给对方。
> 4. 链路层（又名数据链路层，网络接口层）用来处理连接网络的硬件部分。包括控制操作系统、硬件的设备驱动、NIC（Network Interface Card，网络适配器，即网卡），及光纤等物理可见部分（还包括连接器等一切传输媒介）。硬件上的范畴均在链路层的作用范围之内。

发送端在层与层之间传输数据时，每经过一层必定会被打上一个该层所属的首部信息。反之，接收端在层与层传输数据时，每经过一层会把对应的首部消去。这种把数据信息包装起来的做法称为封装（encapsulate）。

## 1.3 与 HTTP 关系密切的协议：IP、TCP 和 DNS
### 负责传输的 IP 协议
IP（Internet Protocol）网络协议位于网络层。IP 协议的作用是把各种数据包传送给对方，而要保证确实传送到对方那里，则需要满足各类条件。其中两个重要的条件是 IP 地址和 MAC 地址（Media Access Control Address）。
1. IP 地址指明了节点被分配到的地址，MAC 地址是指网卡所属的固定地址。两者可以配对，IP地址可变换，MAC 地址基本上不变。
2. 除了通信双方在同一局域网（LAN）的情况，通常是经过多台计算机和网络设备中转才能链接到对方。而中转时，会利用下一站中转设备的 MAC地址来搜索下一个中转目标。采用 ARP 协议（Address Resolution Protocol，用以解析地址的协议），根据通信方的 IP 地址就可以反查出对应的 MAC 地址。中转过程中，计算机和路由器等网络设备只能获悉很粗略的传输路线，这种机制称为路由选择（routing）。

### 确保可靠性的 TCP 协议
TCP 位于传输层，提供可靠的字节流服务（Byte Stream Service）。
> 字节流服务是指为了方便传输，将大块数据分割成以报文段（segment）为单位的数据包进行管理。而可靠的传输服务是指通过三次握手策略（three-way handshaking）等手段能够把数据准确可靠地传给对方。
> 握手过程中使用了 TCP 的标志（flag）：SYN（synchronize）和 ACK（acknowledgement）。
> 发送端首先发送一个带 SYN 标志的数据包给对方，接收端收到后，回传一个带有 SYN/ACK 标志的数据包以示传达确认信息。最后发送端再回传一个带 ACK 标志的数据包，代表“握手”结束。若过程中某个阶段莫名中断，TCP 协议会再次以相同顺序发送相同的数据包。

### 负责域名解析的 DNS 服务
DNS（Domain Name System）服务适合 HTTP 协议一样位于应用层的协议。它提供域名到 IP 地址之间的解析服务。

## 1.4 URI 和 URL
1. URI（Uniform Resource Identifier，统一资源标识符），在 RFC2396中的定义：
* Uniform：规定统一的格式方便处理不同类型资源。另外加入新增的协议方案（如 http: 或 ftp:）也更容易
* Resource：“可标识的任何东西”。
* Identifier：表示可标识的对象。也成为标识符。
> 综上，URI 就是由某个协议方案表示的资源的定位标识符。URI 用字符串标识某一互联网资源，URL 表示资源的地点（互联网上所处的位置）。URL 是 URI 的子集。
2. URI 格式
表示指定的 URI，要使用涵盖全部必要信息的绝对 URI、绝对URL 以及相对 URL。
绝对 URI 的格式：协议方案名 + 登录信息（认证）（可选）+ 服务器地址 + 服务器端口号（可选）+ 带层次的文件路径+ 查询字符串（可选）+ 片段标识符（可选）
> 并不是所有的应用程序都符合 RFC。
> 有一些用来指定 HTTP 协议技术标准的文档，它们被称为 RFC（Request for Comments，征求修正意见书）。
> 通常，应用程序会遵照 RFC 标准，也有部分应用程序自成一套“标准”扩展的情况，作为例外存在。

# 第 2 章  简单的 HTTP 协议
## 2.1 HTTP 协议用于客户端和服务器端之间的通信
示例：
客户端发送请求报文，内容：
> GET /index.htm HTTP/1.1
> 
> Host: hackr.jp

起始行开头的 GET 表示请求访问服务器的类型，称为方法（method）。随后的字符串 /index.htm 指明了请求访问的资源对象，也叫作请求 URI（request-URI）。最后的 HTTP/1.1，即 HTTP 的版本号，用来提示客户端使用的 HTTP 协议功能。
综合来看，这段请求内容的意思是：请求访问某台 HTTP 服务器上的 /index.htm 页面资源。
请求报文是由请求方法、请求 URI、协议版本、可选的请求首部字段和内容实体构成的。

接收到请求的服务器，会将请求内容的处理结果以响应的形式返回。
> HTTP/1.1 200 OK
> 
> Date: Tue, 10 Jul 2012 06:50:15 GMT
> 
> Content-Length: 362
> 
> Content-Type: text/html
> 
> \<html>
> 
> ...

响应报文基本上由协议版本、状态码（status code）（表示请求成功或失败的数字代码）、用以解释状态码的原因短语（reason-phrase）、可选的响应首部字段（header field）以及实体主体（entity body）构成。

## 2.2 HTTP 是不保存状态的协议
HTTP 是一种不保存状态，即无状态（stateless）协议。HTTP 协议自身不对请求和响应之间的通信状态进行保存。也就是在 HTTP 这个级别，协议对于发送过的请求或响应都不做持久化处理。者是为了更快地处理大量事物，确保协议的可伸缩性。
随着 Web 的发展，保存用户状态的需求逐渐增多（比如网站中用户的登录状态），于是引入了 Cookie 技术管理状态。

## 2.3 请求 URI 定位资源
HTTP 协议使用 URI 定位互联网上的资源。当客户端请求访问资源而发送请求时，URI 需要将作为请求报文中的请求 URI 包含在内。指定请求 URI 的方式很多。
* URI 为完整的请求 URI
* 在首部字段 Host 中写明网络域名或 IP 地址
* 除此之外，如果不是访问特定资源而是对服务器本身发起请求，可以用一个 `*` 来代替请求 URI。下面这个例子是查询 HTTP 服务器端支持的 HTTP 方法种类。
> OPTIONS * HTTP/1.1

## 2.4 告知服务器意图的 HTTP 方法
HTTP/1.1中可使用的方法：
* GET：获取资源
  
  GET 方法用来请求访问已被 URI 识别的资源。指定的资源经服务器端解析后返回响应内容。
* POST：传输实体主体

  POST 方法用来传输实体的主体。
* PUT：传输文件

  PUT 方法用来传输文件。就像 FTP 协议的文件上传一样，要求在请求报文的主体中包含文件内容，然后保存到请求 URI 指定的位置。鉴于 HTTP/1.1的 PUT 方法自身不带验证机制导致的安全性问题，一般的 Web 网站不适用该方法。开发 PUT 方法的网站通常会配合 Web 应用程序的验证机制，或架构设计采用 REST（REpresentational State Transfer，表征状态转移）标准。
* HEAD：获得报文首部
  
  HEAD 方法和 GET 方法一样，只是不返回报文主体部分。用于确认 URI 的有效性及资源更新的日期时间等。
* DELETE：删除文件
  
  DELETE方法用来删除文件，是与 PUT 相反的方法。按请求 URI 删除指定的资源。安全性同 PUT方法。
* OPTIONS：询问支持的方法
  
  OPTIONS 方法用来查询针对请求 URI 指定的资源支持的方法。
* TRACE：追踪路径
  
  TRACE 方法是让 Web 服务器端将之前的请求通信环回给客户端的方法。但是不常用，且容易引发 XST（Cross-Site Tracing，跨站追踪）攻击。
* CONNECT：要求用隧道协议连接代理
  
  CONNECT 方法要求在与代理服务器通信时建立隧道，实现用隧道协议进行 TCP 通信。主要使用 SSL（Secure Sockets Layer，安全套接层）和 TLS（Transport Layer Security，传输层安全）协议把通信内容加密后经网络隧道传输。

## 2.5 持久连接节省通信量
HTTP协议的初始版本中，每进行一次 HTTP 通信就要断开一次 TCP 连接。增加了通信量开销。
为了解决上述问题，产生了 HTTP 持久连接（HTTP Persistent Connections，也称为 HTTP keep-alive 或 HTTP connection reuse）的方法。即默认保持 TCP 连接状态，除非任意一端明确提出断开连接。
* 管线化
  
  持久连接使得多数请求以管线化（pipelining）方式发送成为可能。能够支持同时并行发送多个请求，而不需要一个接一个地等待响应了。
## 2.6 使用 Cookie 的状态管理
为了保留 HTTP 无状态协议这个特征，又要解决管理客户端状态的矛盾问题。因此引入了 Cookie 技术。通过在请求和响应报文中写入 Cookie 信息来控制客户端的状态。
Cookie 会根据从服务器端发送的响应报文内的 Set-Cookie 首部字段信息，通知客户端保存 Cookie。当下次客户端再往该服务器发送请求时，客户端会自动在请求报文中加入 Cookie 值后发送。
服务器端发现客户端发送过来的 Cookie 后，会去检查究竟是从哪一个客户端发来的连接请求，然后对比服务器上的记录，最后得到之前的状态信息。

# 第 3 章  HTTP 报文内的 HTTP 信息
## 3.1 HTTP 报文
用于 HTTP 协议交互的信息被称为 HTTP 报文。它是由多行（用 CR+LF 作换行符）数据构成的字符串文本。由最初出现的空行（CR+LF）来划分为报文首部和报文主体（可选）两块。
## 3.2  编码提升传输速率
HTTP 在传输数据时可以按照数据原貌直接传输，也可以在传输过程中通过编码提升传输速率。后者能有效地处理大量访问请求，但是会消耗更多的 CPU 资源。
### 3.2.1 报文主体和实体主体的差异
* 报文（message）：是 HTTP 通信中的基本单位，由 8 位组字节流（octet sequence）组成，通过 HTTP 通信传输。
* 实体（entity）：作为请求或响应的有效载荷数据（补充项）被传输，其内容由实体首部和实体主体组成。

HTTP 报文的主体用于传输请求或响应的实体主体。通常报文主体等于实体主体。编码操作时，实体主体内容发生变化，与报文主题产生差异。

### 3.2.2 常见的内容编码方式
* gzip（GNU zip）
* compress（UNIX 系统的标准压缩）
* deflate（zlib）
* identity（不进行编码）

# 第 4 章  返回结果的 HTTP 状态码
## 4.1 状态码告知从服务器端返回的请求结果
状态码的职责是当客户端向服务器端发送请求时，描述返回的请求结果。借助状态码，用户可以知道服务器端是正常处理了请求，还是出现了错误。

状态码的类别：
||类别|原因短语|
|--|--|----|
|1XX|Informational（信息性状态码）|接受的请求正在处理|
|2XX|Success（成功状态码）|请求正常处理完毕|
|3XX|Redirection（重定向状态码）|需要进行附加操作以完成请求|
|4XX|Client Error（客户端错误状态码）|服务器无法处理请求|
|5XX|Server Error（服务器错误状态码）|服务器处理请求出错|

介绍常用且具有代表性的14个状态码
## 4.2 2XX 成功
### 4.2.1 200 OK 
表示从客户端发来的请求在服务器端被正常处理了。
在响应报文内，随状态码一起返回的信息会因方法的不同而发生改变。比如，使用 GET 方法时，对应请求资源的实体会作为响应返回；而是用 HEAD 方法时，对应请求资源的实体首部不随报文主体作为响应返回（即在响应中只返回首部，不会返回实体的主体部分）。
### 4.2.2 204 No Content 
代表服务器接受的请求已成功处理，但在返回的响应报文中不含实体的主体部分。另外也不允许返回任何实体的主体。用于不需要服务器发送新信息内容的情况。
### 4.2.3 206 Partial Content
表示客户端进行了范围请求，而服务器成功执行了这部分的 GET 请求。响应报文中包含由 Content-Range 指定范围的实体内容。

## 4.3 3XX 重定向
### 4.3.1 301 Moved Permanently
永久性重定向。该状态码表示请求的资源已被分配了新的 URI，以后应使用资源现在所指的 URI。即如果已经把资源对应的 URI 保存为书签了，这时应该按 Location 首部字段提示的 URI 重新保存。
### 4.3.2 302 Found
临时性重定向。与 301 相似，但是代表资源的移动是临时性质的。
### 4.3.3 303 See Other
表示由于请求对应的资源存在着另一个 URI，应使用 GET 方法定向获取请求的资源。
### 4.3.4 304 Not Modified
表示客户端发送附带条件的请求时，服务器端允许请求访问资源，但未满足条件的情况。
304 状态码返回时，不包含任何响应的主体部分。虽然属于 3XX 类别，但和重定向没有关系。
> 附带条件的请求是指采用 GET 方法的请求报文中包含 If-Match，If-Modified——Since，If-None-Match，If-Range，If-Unmodified-Since 中任一首部。
### 4.3.5 307 Temporary Redirect
临时重定向。与 302 Found 含义相同。尽管 302 标准禁止 POST 变换成 GET，但实际使用时大家并不遵守。
307 会遵照浏览器标准，不会从 POST 变成 GET。但是对于处理响应时的行为，每种浏览器有可能出现不同的情况。
## 4.4 4XX 客户端错误
### 4.4.1 400 Bad Request
表示请求报文中存在语法错误。当错误发生时，需修改请求的内容后再次发送请求。另外浏览器会像 200 OK 一样对待该状态码。
### 4.4.2 401 Unauthorized
表示发送的请求需要有通过 HTTP认证（BASIC 认证、DIGEST 认证）的认证信息。另外若之前已进行过 1 次请求，则表示用户认证失败。
返回含有 401 的响应必须包含一个适用于被请求资源的 WWW-Authenticate 首部用以质询（challenge）用户信息。当浏览器初次接收到 401 响应，会弹出认证用的对话窗口。
### 4.4.3 403 Forbidden
表明对请求资源的访问被服务器拒绝了。如果服务器端想作说明，可以在实体的主体部分对原因进行描述，以此让用户看到。
未获得文件系统的访问授权，访问权限出现某些问题（从未授权的发送源 IP 地址试图访问）等列举的情况都可能是发生 403 的原因。
### 4.4.4 404 Not Found
表明服务器上无法找到请求的资源。也可以在服务器端拒绝请求且不想说明理由时使用。
## 4.5 5XX 服务器错误
### 4.5.1 500 Internal Server Error
表明服务器端在执行请求时发生了错误。也可能是 Web 应用存在的 bug 或某些临时的故障。
### 4.5.2 503 Service Unavailable
表明服务器暂时处于超负载或正在进行停机维护，现在无法处理请求。如果事先得知解除以上状况需要的时间，最好写入 RetryAfter 首部字段再返回给客户端。
> 状态码和状况的不一致。
> 
> 不少返回的状态码响应都是错误的，但用户可能察觉不到。比如 Web 应用程序内部发生错误，状态码依然返回 200 OK。

# 第 5 章  与 HTTP 协作的 Web 服务器
一台 Web 服务器可搭建多个独立域名的 Web 网站，也可作为通信路径上的中转服务器提升传输效率。
## 5.1 用单台虚拟主机（Virtual Host，又称虚拟服务器）实现多个域名
客户端使用 HTTP 协议访问服务器时，经常采用主机名和域名的方式，通过 DNS 服务映射到 IP 地址（域名解析）之后访问目标网站。如果一台服务器内托管了两个域名，两者的访问 IP 地址会相同。因此在发送 HTTP 请求时，必须在 Host 首部内完整指定主机名或域名的 URI。

## 5.2 通信数据转发程序：代理、网关、隧道
### 5.2.1 代理
代理是一种有转发功能的应用程序，它扮演了位于服务器和客户端“中间人”的角色，接收由客户端发送的请求并转发给服务器，同时也接收服务器返回的响应并转发给客户端。
使用代理服务器的理由有：利用缓存技术减少网络带宽的流量，组织内部针对特定网站的访问控制，以获取访问日志为主要目的，等等。
代理有多种使用方法，按两种基准分类。一种是是否使用缓存，另一种是是否会修改报文。
* 缓存代理

  代理转发响应时，缓存代理（Caching Proxy）会预先将资源的副本（缓存）保存在代理服务器上。当代理再次接收到对相同资源的请求时，就可以不从源服务器那里获取资源，而是将之前缓存的资源作为响应返回。
* 透明代理

  转发请求或响应时，不对报文做任何加工的代理类型被称为透明代理（Transparent Proxy）。反之，对报文内容进行加工的代理被称为非透明代理。
### 5.2.2 网关
网关是转发其他服务器通信数据的服务器，接收从客户端发送来的请求时，它就像自己拥有资源的源服务器一样对请求进行处理。
网关的工作机制和代理十分相似。而网关能使通信线路上的服务器提供非 HTTP 协议服务。
利用网关能提高通信的安全性，因为可以在客户端和网关之间的通信线路上加密以确保连接的安全。比如，网关可以连接数据库，使用 SQL 语句查询数据。另外，在 Web 购物网站上进行信用卡结算时，网关可以和信用卡结算系统联动。
### 5.2.3 隧道
隧道是在相隔甚远的客户端和服务器两者之间进行中转，并保持双方通信连接的应用程序。
隧道可按要求建立起一条与其他服务器的通信线路，届时使用 SSL 等加密手段进行通信。隧道的目的是确保客户端能与服务器进行安全的通信。

## 5.3 保存资源的缓存
缓存是指代理服务器或客户端本地磁盘内保存的资源副本。可用来减少对源服务器的访问，节省通信流量和通信时间。
### 5.3.1 缓存的有效期限
由于客户端的要求、缓存的有效期等因素，缓存服务器会向源服务器确认资源的有效性。若失效，缓存服务器将会再次获取“新”资源。
### 5.3.2 客户端的缓存
缓存也可存在客户端浏览器中，以 Internet Explorer 程序为例，把客户端缓存称为临时网络文件（Temporary Internet File）。与服务器缓存类似。
